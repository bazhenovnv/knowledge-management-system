# Инструкция по использованию отложенных уведомлений и напоминаний о дедлайнах

## Что это такое?

**Отложенные уведомления** — это уведомления, которые отправляются не сразу, а в указанное время в будущем.

**Напоминания о дедлайнах** — это автоматические уведомления, которые отправляются сотрудникам перед наступлением срока выполнения тестов, курсов или заданий.

## Возможности системы

### 1. Отложенные уведомления

✅ **Планирование на любое время**: Укажите точное время или интервал (минуты, часы, дни)  
✅ **Множество каналов**: База данных, Push-уведомления, Email  
✅ **Типы уведомлений**: Информация, успех, предупреждение, ошибка  
✅ **Автоматические повторы**: Если отправка не удалась, система повторит попытку  

### 2. Напоминания о дедлайнах

✅ **Автоматическая настройка**: Укажите дедлайн один раз, система сама создаст напоминания  
✅ **Гибкие интервалы**: За сутки, за час, в момент дедлайна (настраивается)  
✅ **Для всех типов**: Тесты, курсы, задания  
✅ **Массовые рассылки**: Уведомления получат все назначенные сотрудники  

## Как пользоваться?

### Вариант 1: Через интерфейс (для обычных пользователей)

1. **Настройки → Планировщик**
2. Заполните форму:
   - Заголовок уведомления
   - Текст сообщения
   - Через сколько минут отправить
   - Тип уведомления
   - Каналы (БД / Push / Email)
3. Нажмите **"Запланировать уведомление"**

#### Быстрое планирование

В разделе **"Быстрое планирование"** доступны готовые шаблоны:
- Напоминание через 5 минут
- Важное через час
- Завтра в это время

### Вариант 2: Через код (для разработчиков)

#### Отложенные уведомления

```typescript
import { scheduledNotifications } from '@/utils/scheduledNotifications';

// Отправить через 30 минут
await scheduledNotifications.scheduleInMinutes(30, {
  employeeId: 1,
  type: 'warning',
  title: 'Напоминание о встрече',
  message: 'Встреча начнется через 30 минут',
  channels: ['database', 'push', 'email']
});

// Отправить через 2 часа
await scheduledNotifications.scheduleInHours(2, {
  employeeId: 1,
  type: 'info',
  title: 'Проверьте отчеты',
  message: 'Пора проверить ежедневные отчеты',
  channels: ['database', 'push']
});

// Отправить через 3 дня
await scheduledNotifications.scheduleInDays(3, {
  employeeId: 1,
  type: 'info',
  title: 'Еженедельная сводка',
  message: 'Ваша еженедельная статистика готова',
  channels: ['email']
});

// Отправить в конкретное время
await scheduledNotifications.scheduleNotification({
  employeeId: 1,
  type: 'success',
  title: 'С днем рождения!',
  message: 'Поздравляем с днем рождения!',
  scheduledFor: new Date('2025-10-20T09:00:00'),
  channels: ['database', 'push', 'email']
});
```

#### Напоминания о дедлайнах

```typescript
import { scheduledNotifications } from '@/utils/scheduledNotifications';

// Установить напоминание для теста
await scheduledNotifications.setTestDeadline(
  1, // testId
  new Date('2025-10-25T15:00:00'), // deadline
  [86400, 3600, 0] // за сутки, за час, в момент дедлайна
);

// Установить напоминание для курса
await scheduledNotifications.setCourseDeadline(
  2, // courseId
  new Date('2025-11-01T12:00:00'),
  [172800, 86400, 3600] // за 2 дня, за сутки, за час
);

// Установить напоминание для задания
await scheduledNotifications.setTaskDeadline(
  5, // taskId
  new Date('2025-10-18T18:00:00'),
  [3600, 1800, 0] // за час, за 30 минут, в момент дедлайна
);
```

## Интервалы напоминаний

Интервалы указываются в **секундах** до дедлайна:

| Интервал | Секунды | Описание |
|----------|---------|----------|
| 5 минут | 300 | За 5 минут до дедлайна |
| 30 минут | 1800 | За 30 минут до дедлайна |
| 1 час | 3600 | За час до дедлайна |
| 3 часа | 10800 | За 3 часа до дедлайна |
| 1 сутки | 86400 | За сутки до дедлайна |
| 2 дня | 172800 | За 2 дня до дедлайна |
| 1 неделя | 604800 | За неделю до дедлайна |
| В момент | 0 | Точно в момент дедлайна |

Пример:
```typescript
[604800, 86400, 3600, 0] 
// = за неделю, за сутки, за час, в момент дедлайна
```

## Обработка отложенных уведомлений

Система автоматически проверяет и отправляет отложенные уведомления.

### Автоматическая обработка

Можно настроить cron-задачу для автоматической проверки:

```bash
# Каждую минуту
* * * * * curl "https://your-api.com/email-notifications?action=process"

# Каждые 5 минут
*/5 * * * * curl "https://your-api.com/email-notifications?action=process"
```

### Ручная обработка (для тестирования)

```typescript
import { scheduledNotifications } from '@/utils/scheduledNotifications';

const result = await scheduledNotifications.processScheduled();

console.log('Обработано:', result.scheduled.processed);
console.log('Ошибок:', result.scheduled.failed);
console.log('Создано напоминаний:', result.deadlines.notifications_created);
```

## Каналы отправки

### database (База данных)
- ✅ Всегда работает
- ✅ Сохраняет историю уведомлений
- ✅ Отображается в интерфейсе

### push (Push-уведомления)
- ✅ Моментальная доставка в браузер
- ⚠️ Работает только если вкладка открыта
- ⚠️ Требует разрешения от пользователя

### email (Email-рассылка)
- ✅ Надежная доставка
- ✅ Работает всегда (даже если пользователь не в системе)
- ⚠️ Требует настройки SMTP (см. email-setup-guide.md)

## Типы уведомлений

| Тип | Цвет | Иконка | Использование |
|-----|------|--------|---------------|
| info | Синий | ℹ️ | Общая информация |
| success | Зеленый | ✅ | Успешные операции |
| warning | Оранжевый | ⚠️ | Предупреждения |
| error | Красный | ❌ | Ошибки |
| deadline | Желтый | ⏰ | Дедлайны (автоматически) |

## Примеры использования

### Напоминание о тесте за сутки до дедлайна

```typescript
// При создании теста с дедлайном
await scheduledNotifications.setTestDeadline(
  testId,
  new Date('2025-10-30T12:00:00'),
  [86400, 3600, 0] // за сутки, за час, в момент
);
```

Система автоматически создаст 3 уведомления:
- **29 октября в 12:00**: "⏰ Дедлайн через 1 дн: Тест по безопасности"
- **30 октября в 11:00**: "⏰ Дедлайн через 1 ч: Тест по безопасности"
- **30 октября в 12:00**: "⏰ Дедлайн наступил: Тест по безопасности"

### Еженедельная рассылка отчетов

```typescript
// Отправить каждый понедельник в 9:00
const nextMonday = new Date();
nextMonday.setDate(nextMonday.getDate() + (1 + 7 - nextMonday.getDay()) % 7);
nextMonday.setHours(9, 0, 0, 0);

await scheduledNotifications.scheduleNotification({
  employeeId: employeeId,
  type: 'info',
  title: 'Еженедельный отчет',
  message: 'Ваша статистика за неделю готова',
  scheduledFor: nextMonday,
  channels: ['email']
});
```

### Напоминание о встрече за 15 минут

```typescript
await scheduledNotifications.scheduleInMinutes(15, {
  employeeId: employeeId,
  type: 'warning',
  title: 'Встреча скоро начнется',
  message: 'Встреча с руководством через 15 минут',
  channels: ['push', 'database']
});
```

## Статусы отложенных уведомлений

| Статус | Описание |
|--------|----------|
| pending | Ожидает отправки |
| sent | Успешно отправлено |
| failed | Ошибка отправки (после 3 попыток) |
| cancelled | Отменено вручную |

## Устранение проблем

### Уведомления не отправляются
- Проверьте, настроен ли планировщик (cron или автоматический запуск)
- Убедитесь, что `scheduledFor` - это время в будущем
- Проверьте логи backend функции

### Email не отправляются
- Убедитесь, что SMTP настроен (см. email-setup-guide.md)
- Проверьте секреты в настройках проекта
- Канал 'email' должен быть включен в списке каналов

### Push-уведомления не приходят
- Проверьте, что у пользователя включены push в настройках
- Убедитесь, что вкладка браузера открыта
- Проверьте разрешения браузера на уведомления

## Ограничения

⚠️ **Максимум 100 уведомлений за раз**: За один вызов обрабатывается до 100 уведомлений  
⚠️ **3 попытки повтора**: Если отправка не удалась 3 раза, статус меняется на 'failed'  
⚠️ **Email лимиты**: Gmail/Яндекс - 500 писем/день, Mail.ru - 300 писем/день  

## API Reference

### scheduledNotifications.scheduleNotification()
Планирует отправку уведомления в указанное время

### scheduledNotifications.scheduleInMinutes()
Планирует отправку через N минут

### scheduledNotifications.scheduleInHours()
Планирует отправку через N часов

### scheduledNotifications.scheduleInDays()
Планирует отправку через N дней

### scheduledNotifications.setDeadlineReminder()
Устанавливает автоматические напоминания о дедлайне

### scheduledNotifications.setTestDeadline()
Устанавливает напоминания для теста

### scheduledNotifications.setCourseDeadline()
Устанавливает напоминания для курса

### scheduledNotifications.setTaskDeadline()
Устанавливает напоминания для задания

### scheduledNotifications.processScheduled()
Обрабатывает отложенные уведомления и создает напоминания о дедлайнах
